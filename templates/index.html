<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Блокнот MVP</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            margin: 0;
            height: 100vh;
        }
        #sidebar {
            width: 250px;
            border-right: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }
        #content {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
        }
        .page {
            cursor: pointer;
            padding: 5px;
        }
        .page:hover {
            background: #eee;
        }
        input, textarea {
            width: 100%;
            margin-bottom: 5px;
        }
        textarea {
            height: 70vh;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>Страницы</h3>
    <div id="pages"></div>

    <input id="newTitle" placeholder="Новая страница">
    <button onclick="createPage()">Создать</button>
</div>

<div id="content">
    <input id="title" placeholder="Заголовок" oninput="scheduleAutosave()">
    <textarea id="text" oninput="scheduleAutosave()"></textarea>


    <button onclick="autosave()">Сохранить</button>
    <button onclick="removePage()" style="color: red;">Удалить страницу</button>

    <div id="status" style="font-size: 12px; color: gray;"></div>
</div>

<script>
    let saveTimer = null;
    const SAVE_DELAY = 1500; // мс
    let currentId = null;

    // Автосохранение с задержкой
    function scheduleAutosave() {
        if (!currentId) return;

        document.getElementById("status").innerText = "Изменения не сохранены";

        if (saveTimer) clearTimeout(saveTimer);

        saveTimer = setTimeout(() => {
            autosave();
        }, SAVE_DELAY);
    }

    // Сохранение текущей страницы (автосейв или кнопка)
    async function autosave() {
        if (!currentId) return;

        const title = document.getElementById("title").value;
        const content = document.getElementById("text").value;

        try {
            const res = await fetch(
                `/pages/${currentId}?title=${encodeURIComponent(title)}&content=${encodeURIComponent(content)}`,
                { method: "PUT" }
            );

            const updatedPage = await res.json();

            // Обновляем состояние страницы после сохранения
            document.getElementById("title").value = updatedPage.title;
            document.getElementById("text").value = updatedPage.content;

            document.getElementById("status").innerText = "Сохранено";
        } catch (err) {
            console.error(err);
            document.getElementById("status").innerText = "Ошибка при сохранении";
        }
    }

    // Загрузка всех страниц
    async function loadPages() {
        const res = await fetch("/pages");
        const pages = await res.json();

        const list = document.getElementById("pages");
        list.innerHTML = "";

        for (const id in pages) {
            const div = document.createElement("div");
            div.className = "page";
            div.innerText = pages[id].title;
            div.onclick = () => openPage(id, pages[id]);
            list.appendChild(div);
        }
    }

    // Удаление страницы
    async function removePage() {
        if (!currentId) return;
        if (!confirm("Удалить страницу?")) return;

        await fetch(`/pages/${currentId}`, { method: "DELETE" });

        currentId = null;
        document.getElementById("title").value = "";
        document.getElementById("text").value = "";
        document.getElementById("status").innerText = "";

        await loadPages();
    }

    // Открытие страницы
    async function openPage(id) {
        currentId = id;

        const res = await fetch(`/pages`);
        const pages = await res.json();

        const page = pages[id];
        if (!page) return;

        document.getElementById("title").value = page.title;
        document.getElementById("text").value = page.content;
        document.getElementById("status").innerText = "";
    }

    // Создание новой страницы
    async function createPage() {
        const title = document.getElementById("newTitle").value;
        if (!title) return;

        try {
            const res = await fetch("/pages?title=" + encodeURIComponent(title), { method: "POST" });
            const page = await res.json();

            // Сразу открываем новую страницу
            currentId = page.id;
            document.getElementById("title").value = page.title;
            document.getElementById("text").value = page.content;

            document.getElementById("newTitle").value = "";
            await loadPages();
        } catch (err) {
            console.error(err);
        }
    }

    // Сохранение по кнопке
    async function save() {
        if (!currentId) return;
        await autosave();
    }

    // Инициализация
    loadPages();
</script>


</body>
</html>
